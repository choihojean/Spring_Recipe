<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>레시피 상세 정보</title>
    <style>
        .comment-section {
            margin-top: 30px;
        }

        .comment {
            padding: 10px;
            margin-bottom: 5px;
        }

        .comment-title {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 5px;
        }

        .comment-content {
            font-size: 1rem;
            margin: 0 5px;
        }

        .comment-form {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .comment-form textarea {
            width: 100%;
            padding: 10px;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: none;
            outline: none;
            box-sizing: border-box;
        }

        .comment-form button {
            align-self: flex-end;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
        }
    </style>
    <script>
        function forEachData(cc, data, index) {
            data.forEach(comment => {
                const container = document.createElement('div');
                container.style = index > 0 ? `margin-left: ${20 * index}px; border-left: 2px solid #ddd;` : "";

                const commentDiv = document.createElement('div');
                commentDiv.classList.add('comment');

                const commentTitle = document.createElement('div');
                commentTitle.classList.add('comment-title');
                commentTitle.textContent = comment.userNickname;

                const commentContent = document.createElement('p');
                commentContent.classList.add('comment-content');
                commentContent.textContent = comment.content;

                commentDiv.appendChild(commentTitle);
                commentDiv.appendChild(commentContent);

                container.appendChild(commentDiv);

                cc.appendChild(container);

                if(comment.childComments) {
                    forEachData(cc, comment.childComments, index + 1);
                }
            });
        }

        function loadComments() {
            const cc = document.getElementById('comment-container');
            const recipeId = window.location.pathname.split('/').pop();
            const param = new URLSearchParams({"recipeId": recipeId});

            fetch(`/api/comments?${param.toString()}`)
                .then(res => {
                    if (!res.ok) {
                        throw new Error("error");
                    }
                    return res.json();
                })
                .then(data => {
                    forEachData(cc, data, 0);
                })
                .catch(error => {
                    console.error(error);
                });
        }

        window.addEventListener('load', function () {
            loadComments();
        });
    </script>
</head>
<body>
<h1 th:text="${recipe.recipeName}">레시피</h1>
<p><strong>작성자:</strong> <span th:text="${recipe.writer}">작성자 닉네임</span></p>

<!--<p><strong>재료:</strong> <span th:text="${recipe.ingredients}">재료 리스트</span></p>-->
<p><strong>조리법:</strong> <span th:text="${recipe.cookery}">조리법 설명</span></p>
<p><strong>요리 시간:</strong> <span th:text="${recipe.cookingTime}">요리 시간 (분)</span> 분</p>
<p><strong>난이도:</strong> <span th:text="${recipe.difficultyLevel}">난이도</span></p>

<div th:if="${isWriter}">
    <a th:href="@{/edit/{id}(id=${recipe.id})}" class="button">수정</a>
</div>
<a th:href="@{/main}">목록으로 돌아가기</a>
<div id="comment-container"></div>
<div class="comment-section">
    <div class="comment-form">
        <textarea placeholder="댓글을 입력하세요..." rows="4" readonly></textarea>
        <button type="button">댓글 작성</button>
    </div>
</div>
</body>
</html>